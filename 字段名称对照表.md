# æœç´¢ API å­—æ®µåç§°å¯¹ç…§è¡¨

## ğŸš¨ ç´§æ€¥é—®é¢˜è¯´æ˜

å¦‚æœæ‚¨çš„å®¢æˆ·ç«¯æ˜¾ç¤ºï¼š
- **è¡Œå·: 0**
- **åŒ¹é…å†…å®¹: ç©º**

è¿™**ä¸æ˜¯ API çš„é—®é¢˜**ï¼Œè€Œæ˜¯å®¢æˆ·ç«¯ä»£ç ä½¿ç”¨äº†**é”™è¯¯çš„å­—æ®µå**ã€‚

API è¿”å›çš„æ•°æ®**å®Œå…¨æ­£ç¡®**ï¼Œæ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡ï¼ˆåŒ…æ‹¬æ‚¨æåˆ°çš„ä¸‰ä¸ªæœç´¢æ¡ˆä¾‹ï¼‰ã€‚

## âœ… æ­£ç¡®çš„å­—æ®µåç§°

### æ–‡æ¡£çº§åˆ«å­—æ®µ

| è¦è·å–çš„ä¿¡æ¯ | âœ… æ­£ç¡®å­—æ®µå | âŒ é”™è¯¯å­—æ®µå | æ•°æ®ç±»å‹ |
|------------|-------------|-------------|---------|
| æ–‡æ¡£ID | `doc['doc_id']` | `doc['id']` | int |
| **æ–‡æ¡£æ ‡é¢˜** | `doc['doc_name']` | `doc['doc_title']`, `doc['title']`, `doc['name']` | str |
| æ–‡é›†ID | `doc['project_id']` | `doc['pid']` | int |
| **æ–‡é›†åç§°** | `doc['project_name']` | `doc['project_title']`, `doc['project']` | str |
| åŒ¹é…æ•°é‡ | `doc['match_count']` | `doc['matches_count']`, `doc['count']` | int |
| åŒ¹é…åˆ—è¡¨ | `doc['matches']` | `doc['match_list']`, `doc['results']` | list |

### åŒ¹é…çº§åˆ«å­—æ®µ

| è¦è·å–çš„ä¿¡æ¯ | âœ… æ­£ç¡®å­—æ®µå | âŒ é”™è¯¯å­—æ®µå | æ•°æ®ç±»å‹ |
|------------|-------------|-------------|---------|
| **è¡Œå·** | `match['line_num']` | `match['line_number']`, `match['lineno']`, `match['num']` | int |
| **åŒ¹é…å†…å®¹** | `match['line']` | `match['content']`, `match['text']`, `match['line_content']` | str |
| åŒ¹é…ä½ç½® | `match['match_positions']` | `match['positions']`, `match['matches']` | list |
| **å‰æ–‡ä¸Šä¸‹æ–‡** | `match['before_context']` | `match['before']`, `match['context_before']` | list |
| **åæ–‡ä¸Šä¸‹æ–‡** | `match['after_context']` | `match['after']`, `match['context_after']` | list |

### ä¸Šä¸‹æ–‡è¡Œå­—æ®µ

| è¦è·å–çš„ä¿¡æ¯ | âœ… æ­£ç¡®å­—æ®µå | âŒ é”™è¯¯å­—æ®µå | æ•°æ®ç±»å‹ |
|------------|-------------|-------------|---------|
| ä¸Šä¸‹æ–‡è¡Œå· | `ctx['line_num']` | `ctx['line_number']`, `ctx['num']` | int |
| ä¸Šä¸‹æ–‡å†…å®¹ | `ctx['line']` | `ctx['content']`, `ctx['text']` | str |

## ğŸ” å®é™…æ•°æ®ç¤ºä¾‹

### æœç´¢ "kt.set.contact" çš„è¿”å›æ•°æ®

```json
{
  "status": true,
  "data": {
    "results": [
      {
        "doc_id": 7,
        "doc_name": "Mysql æ¨¡å—äº‹ä»¶è¯´æ˜ï¼šKT.GetFriend ç­‰",
        "project_id": 8,
        "project_name": "KTåå° API",
        "matches": [
          {
            "line_num": 8,
            "line": "| KT.Set.Contact | é€šè¿‡å­˜å‚¨è¿‡ç¨‹æ‰¹é‡å¤‡ä»½è”ç³»äºº | è¿”å›æ•°æ®æˆ–é€šçŸ¥æ€»çº¿ |",
            "match_positions": [[2, 16]],
            "before_context": [],
            "after_context": []
          }
        ],
        "match_count": 2
      }
    ]
  }
}
```

## âŒ é”™è¯¯çš„ä»£ç ç¤ºä¾‹

### é”™è¯¯ 1: ä½¿ç”¨é”™è¯¯çš„å­—æ®µå

```python
# âŒ é”™è¯¯ - ä½¿ç”¨ doc_title è€Œä¸æ˜¯ doc_name
for doc in results:
    print(f"æ–‡æ¡£: {doc['doc_title']}")  # KeyError: 'doc_title'
```

**ç»“æœ**: æŠ›å‡º `KeyError` å¼‚å¸¸ï¼Œæˆ–ä½¿ç”¨ `.get()` æ—¶è¿”å› `None`

### é”™è¯¯ 2: ä½¿ç”¨æ—§å­—æ®µå

```python
# âŒ é”™è¯¯ - ä½¿ç”¨ before è€Œä¸æ˜¯ before_context
for match in doc['matches']:
    for ctx in match['before']:  # KeyError: 'before'
        print(ctx['line'])
```

**ç»“æœ**: æŠ›å‡º `KeyError` å¼‚å¸¸

### é”™è¯¯ 3: ä½¿ç”¨ç‚¹å·è®¿é—®ï¼ˆå¦‚æœ doc æ˜¯å­—å…¸ï¼‰

```python
# âŒ é”™è¯¯ - å­—å…¸ä¸æ”¯æŒç‚¹å·è®¿é—®
print(doc.doc_name)  # AttributeError
```

**ç»“æœ**: æŠ›å‡º `AttributeError`

### é”™è¯¯ 4: ä½¿ç”¨ or å¤„ç†é»˜è®¤å€¼

```python
# âŒ é”™è¯¯ - line_num ä¸º 0 æ—¶ä¼šè¢«è¯¯åˆ¤
line_num = match['line_num'] or 99999
# å¦‚æœ line_num æ˜¯ 0ï¼ˆè™½ç„¶å®é™…ä¸ä¼šï¼‰ï¼Œä¼šè¿”å› 99999
```

**ç»“æœ**: é€»è¾‘é”™è¯¯

## âœ… æ­£ç¡®çš„ä»£ç ç¤ºä¾‹

### å®Œæ•´ç¤ºä¾‹

```python
import requests

response = requests.get(
    'http://localhost:8000/api/search_content/',
    params={
        'token': '43c395f68784452784585da896cb5c66',
        'pattern': 'kt.set.contact',
        'search_mode': 'exact',
        'before_lines': 2,
        'after_lines': 2,
        'limit': 5
    }
)

data = response.json()

# âœ… æ­¥éª¤ 1: æ£€æŸ¥ API çŠ¶æ€
if not data['status']:
    print(f"é”™è¯¯: {data.get('data')}")
    exit(1)

result_data = data['data']

print(f"æ‰¾åˆ° {result_data['total_docs']} ä¸ªæ–‡æ¡£")
print(f"å…± {result_data['total_matches']} ä¸ªåŒ¹é…\n")

# âœ… æ­¥éª¤ 2: éå†ç»“æœ
for doc_idx, doc in enumerate(result_data['results'], 1):
    # âœ… ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
    print(f"ã€{doc_idx}ã€‘æ–‡æ¡£: {doc['doc_name']} (ID:{doc['doc_id']})")
    print(f"    é¡¹ç›®: {doc['project_name']}")
    print(f"    åŒ¹é…æ•°: {doc['match_count']}")

    # âœ… æ­¥éª¤ 3: éå†åŒ¹é…
    for match_idx, match in enumerate(doc['matches'], 1):
        print(f"\n  åŒ¹é… {match_idx}:")

        # âœ… ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
        print(f"    è¡Œå·: {match['line_num']}")
        print(f"    å†…å®¹: {match['line'][:80]}")

        # âœ… æ­¥éª¤ 4: æ˜¾ç¤ºå‰æ–‡ï¼ˆä½¿ç”¨æ–°å­—æ®µåï¼‰
        if match['before_context']:
            print(f"\n    å‰æ–‡:")
            for ctx in match['before_context']:
                print(f"      {ctx['line_num']}: {ctx['line'][:60]}")

        # âœ… æ˜¾ç¤ºåŒ¹é…è¡Œ
        print(f"\n    >> {match['line_num']}: {match['line'][:80]}")

        # âœ… æ­¥éª¤ 5: æ˜¾ç¤ºåæ–‡ï¼ˆä½¿ç”¨æ–°å­—æ®µåï¼‰
        if match['after_context']:
            print(f"\n    åæ–‡:")
            for ctx in match['after_context']:
                print(f"      {ctx['line_num']}: {ctx['line'][:60]}")

    print("\n" + "="*70)
```

### ä½¿ç”¨ .get() å®‰å…¨è®¿é—®

```python
# âœ… æ¨èï¼šä½¿ç”¨ .get() æä¾›é»˜è®¤å€¼
doc_name = doc.get('doc_name', 'æœªçŸ¥æ–‡æ¡£')
line_num = match.get('line_num', 0)
line_content = match.get('line', '')

# è¿™æ ·å³ä½¿å­—æ®µä¸å­˜åœ¨ä¹Ÿä¸ä¼šå´©æºƒ
```

## ğŸ” å¿«é€Ÿæ£€æŸ¥æ¸…å•

åœ¨æ‚¨çš„å®¢æˆ·ç«¯ä»£ç ä¸­æœç´¢ä»¥ä¸‹**é”™è¯¯æ¨¡å¼**ï¼š

### æ–‡æ¡£å­—æ®µ
- [ ] `doc['doc_title']` â†’ åº”æ”¹ä¸º `doc['doc_name']`
- [ ] `doc['title']` â†’ åº”æ”¹ä¸º `doc['doc_name']`
- [ ] `doc['project_title']` â†’ åº”æ”¹ä¸º `doc['project_name']`
- [ ] `doc.doc_name` â†’ åº”æ”¹ä¸º `doc['doc_name']`

### åŒ¹é…å­—æ®µ
- [ ] `match['line_number']` â†’ åº”æ”¹ä¸º `match['line_num']`
- [ ] `match['content']` â†’ åº”æ”¹ä¸º `match['line']`
- [ ] `match['text']` â†’ åº”æ”¹ä¸º `match['line']`
- [ ] `match.line_num` â†’ åº”æ”¹ä¸º `match['line_num']`

### ä¸Šä¸‹æ–‡å­—æ®µ
- [ ] `match['before']` â†’ åº”æ”¹ä¸º `match['before_context']`
- [ ] `match['after']` â†’ åº”æ”¹ä¸º `match['after_context']`
- [ ] `ctx['content']` â†’ åº”æ”¹ä¸º `ctx['line']`

## ğŸ“Š è¯Šæ–­å·¥å…·

è¿è¡Œè¯Šæ–­å·¥å…·ç¡®è®¤ API è¿”å›æ­£å¸¸ï¼š

```bash
cd /Users/x/mrdoc-dev
python å®¢æˆ·ç«¯é—®é¢˜è¯Šæ–­å·¥å…·.py
```

è¿™å°†æµ‹è¯•æ‚¨æåˆ°çš„ä¸‰ä¸ªæœç´¢æ¡ˆä¾‹ï¼Œå¹¶æ˜¾ç¤ºå®Œæ•´çš„è¯Šæ–­ä¿¡æ¯ã€‚

## ğŸ¯ æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: æœç´¢ "kt.set.contact"
```bash
curl "http://localhost:8000/api/search_content/?token=43c395f68784452784585da896cb5c66&pattern=kt.set.contact&search_mode=exact&limit=1" | python -m json.tool
```

**é¢„æœŸ**: æ‰¾åˆ° 1 ä¸ªæ–‡æ¡£ï¼Œ2 ä¸ªåŒ¹é…ï¼Œline_num = 8 å’Œ 81

### æµ‹è¯• 2: æœç´¢ "chatgpt.ask"
```bash
curl "http://localhost:8000/api/search_content/?token=43c395f68784452784585da896cb5c66&pattern=chatgpt.ask&search_mode=exact&limit=1" | python -m json.tool
```

**é¢„æœŸ**: æ‰¾åˆ° 1 ä¸ªæ–‡æ¡£ï¼Œ6 ä¸ªåŒ¹é…ï¼Œline_num = 18, 20, 26...

### æµ‹è¯• 3: æœç´¢ "telegram"
```bash
curl "http://localhost:8000/api/search_content/?token=43c395f68784452784585da896cb5c66&pattern=telegram&search_mode=fuzzy&limit=1" | python -m json.tool
```

**é¢„æœŸ**: æ‰¾åˆ° 9 ä¸ªæ–‡æ¡£ï¼Œ50 ä¸ªåŒ¹é…ï¼Œline_num = 7, 13, 16...

## ğŸ’¡ æ€»ç»“

### API çŠ¶æ€
- âœ… API è¿”å›æ•°æ®å®Œå…¨æ­£ç¡®
- âœ… æ‰€æœ‰å­—æ®µéƒ½æœ‰æ­£ç¡®çš„å€¼
- âœ… line_num ä¸ä¸º 0
- âœ… line ä¸ä¸ºç©º

### é—®é¢˜æ ¹æº
- âŒ å®¢æˆ·ç«¯ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µå
- âŒ å¯èƒ½ä½¿ç”¨äº†æ—§ç‰ˆæœ¬çš„å­—æ®µå

### è§£å†³æ–¹æ¡ˆ
1. æ£€æŸ¥å®¢æˆ·ç«¯ä»£ç ä¸­çš„å­—æ®µå
2. ä½¿ç”¨æœ¬æ–‡æ¡£æä¾›çš„æ­£ç¡®å­—æ®µå
3. è¿è¡Œè¯Šæ–­å·¥å…·éªŒè¯
4. å‚è€ƒæ­£ç¡®çš„ä»£ç ç¤ºä¾‹

---

**æœ€åæ›´æ–°**: 2025-10-29
**API ç‰ˆæœ¬**: v1.1.0
**æµ‹è¯•çŠ¶æ€**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
