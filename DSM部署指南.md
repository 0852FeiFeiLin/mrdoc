# MrDoc Docker ç¾¤æ™–DSMéƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²ä¿¡æ¯

### ç³»ç»Ÿä¿¡æ¯
- **MrDocç‰ˆæœ¬**: 0.9.6
- **åŒ…å«æ•°æ®**: 128ç¯‡æ–‡æ¡£ï¼Œ29ä¸ªæ–‡é›†
- **æ•°æ®åº“**: SQLiteï¼ˆå·²åŒ…å«åœ¨é•œåƒä¸­ï¼‰
- **ç®¡ç†å‘˜è´¦å·**: admin / admin123
- **API Token**: 43c395f68784452784585da896cb5c66

### æ‰€æœ‰æ–‡é›†å·²è®¾ç½®ä¸ºç§å¯†
æ‰€æœ‰29ä¸ªæ–‡é›†çš„æƒé™éƒ½å·²è®¾ç½®ä¸ºç§å¯†ï¼ˆrole=1ï¼‰ï¼Œåªæœ‰ç™»å½•ç”¨æˆ·å¯ä»¥è®¿é—®ã€‚

## ğŸš€ å¿«é€Ÿéƒ¨ç½²æ­¥éª¤

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨Docker Composeï¼ˆæ¨èï¼‰

#### 1. ä¸Šä¼ æ–‡ä»¶åˆ°DSM

1. æ‰“å¼€DSM **File Station**
2. åˆ›å»ºéƒ¨ç½²ç›®å½•ï¼Œä¾‹å¦‚ `/docker/mrdoc`
3. ä¸Šä¼ ä»¥ä¸‹æ–‡ä»¶åˆ°è¯¥ç›®å½•ï¼š
   - æ•´ä¸ª `mrdoc-dev` æ–‡ä»¶å¤¹
   - æˆ–è€…ä¸Šä¼ æ‰“åŒ…å¥½çš„ `mrdoc-docker-dsm.tar.gz` å¹¶è§£å‹

#### 2. SSHç™»å½•DSM

```bash
ssh ä½ çš„DSMç”¨æˆ·å@DSMçš„IPåœ°å€
```

#### 3. è¿›å…¥éƒ¨ç½²ç›®å½•

```bash
cd /volume1/docker/mrdoc
# æˆ–è€…ä½ åˆ›å»ºçš„å…¶ä»–è·¯å¾„
```

#### 4. å¯åŠ¨å®¹å™¨

```bash
sudo docker-compose -f docker-compose-dsm.yml up -d
```

#### 5. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—

```bash
sudo docker-compose -f docker-compose-dsm.yml logs -f
```

çœ‹åˆ°ä»¥ä¸‹ä¿¡æ¯è¡¨ç¤ºå¯åŠ¨æˆåŠŸï¼š
```
âœ… åˆå§‹åŒ–å®Œæˆï¼
ğŸ“Œ è®¿é—®åœ°å€: http://ä½ çš„DSMåœ°å€:8000
ğŸ“Œ ç®¡ç†å‘˜è´¦å·: admin
ğŸ“Œ ç®¡ç†å‘˜å¯†ç : admin123
ğŸš€ å¯åŠ¨MrDocæœåŠ¡...
```

æŒ‰ `Ctrl+C` é€€å‡ºæ—¥å¿—æŸ¥çœ‹ã€‚

#### 6. è®¿é—®MrDoc

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://ä½ çš„DSMåœ°å€:8000`

### æ–¹æ³•äºŒï¼šä½¿ç”¨DSM Dockerå›¾å½¢ç•Œé¢

#### 1. æ‰“å¼€DSM Dockeråº”ç”¨

åœ¨DSMæ¡Œé¢æ‰¾åˆ°å¹¶æ‰“å¼€ **Docker** åº”ç”¨ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œéœ€è¦å…ˆåœ¨**å¥—ä»¶ä¸­å¿ƒ**å®‰è£…ï¼‰

#### 2. ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

1. æ‰“å¼€**File Station**
2. åˆ›å»ºç›®å½• `/docker/mrdoc`
3. ä¸Šä¼ æ•´ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹åˆ°æ­¤ç›®å½•

#### 3. æ„å»ºé•œåƒ

1. æ‰“å¼€**Docker** â†’ **æ˜ åƒ**
2. ç‚¹å‡»**æ–°å¢** â†’ **ä»æ–‡ä»¶æ·»åŠ **
3. æµè§ˆé€‰æ‹© `/docker/mrdoc/Dockerfile.dsm`
4. é•œåƒåç§°å¡«å†™ï¼š`mrdoc-dsm:latest`
5. ç‚¹å‡»**æ„å»º**ï¼Œç­‰å¾…æ„å»ºå®Œæˆï¼ˆçº¦5-10åˆ†é’Ÿï¼‰

#### 4. åˆ›å»ºå®¹å™¨

1. åœ¨**æ˜ åƒ**åˆ—è¡¨ä¸­æ‰¾åˆ° `mrdoc-dsm:latest`
2. é€‰ä¸­åç‚¹å‡»**å¯åŠ¨**
3. è¿›å…¥**åˆ›å»ºå®¹å™¨**å‘å¯¼

**å¸¸è§„è®¾ç½®**ï¼š
- å®¹å™¨åç§°ï¼š`mrdoc-dsm`
- å¯ç”¨è‡ªåŠ¨é‡æ–°å¯åŠ¨ï¼šâœ“

**é«˜çº§è®¾ç½®**ï¼š

**ç«¯å£è®¾ç½®**ï¼š
- æœ¬åœ°ç«¯å£ï¼š8000
- å®¹å™¨ç«¯å£ï¼š8000
- ç±»å‹ï¼šTCP

**å·è®¾ç½®**ï¼ˆæ·»åŠ 4ä¸ªæ–‡ä»¶å¤¹ï¼‰ï¼š
| æ–‡ä»¶å¤¹ | è£…è½½è·¯å¾„ | è¯´æ˜ |
|-------|---------|------|
| `/docker/mrdoc/data/db` | `/app/db.sqlite3` | æ•°æ®åº“æ–‡ä»¶ |
| `/docker/mrdoc/data/media` | `/app/media` | åª’ä½“æ–‡ä»¶ |
| `/docker/mrdoc/data/log` | `/app/log` | æ—¥å¿—æ–‡ä»¶ |
| `/docker/mrdoc/data/whoosh_index` | `/app/whoosh_index` | æœç´¢ç´¢å¼• |

**ç¯å¢ƒ**ï¼š
```
PYTHONUNBUFFERED=1
DJANGO_SETTINGS_MODULE=MrDoc.settings
TZ=Asia/Shanghai
```

#### 5. å¯åŠ¨å®¹å™¨

å®Œæˆé…ç½®åç‚¹å‡»**åº”ç”¨**ï¼Œå®¹å™¨ä¼šè‡ªåŠ¨å¯åŠ¨ã€‚

#### 6. æŸ¥çœ‹æ—¥å¿—

1. åœ¨**å®¹å™¨**åˆ—è¡¨ä¸­æ‰¾åˆ° `mrdoc-dsm`
2. é€‰ä¸­åç‚¹å‡»**è¯¦æƒ…**
3. åˆ‡æ¢åˆ°**æ—¥å¿—**æ ‡ç­¾
4. ç¡®è®¤çœ‹åˆ°åˆå§‹åŒ–å®Œæˆçš„æ¶ˆæ¯

#### 7. è®¿é—®MrDoc

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://ä½ çš„DSMåœ°å€:8000`

## ğŸ“ é¦–æ¬¡ä½¿ç”¨

### 1. ç™»å½•ç³»ç»Ÿ

- è®¿é—®åœ°å€ï¼š`http://ä½ çš„DSMåœ°å€:8000`
- ç®¡ç†å‘˜è´¦å·ï¼š`admin`
- ç®¡ç†å‘˜å¯†ç ï¼š`admin123`

### 2. ç³»ç»ŸåŒ…å«çš„æ•°æ®

éƒ¨ç½²å®Œæˆåï¼Œç³»ç»Ÿå·²åŒ…å«ï¼š
- âœ… 128ç¯‡æ–‡æ¡£
- âœ… 29ä¸ªæ–‡é›†ï¼ˆæ‰€æœ‰æ–‡é›†å·²è®¾ç½®ä¸ºç§å¯†ï¼‰
- âœ… æœç´¢ç´¢å¼•å·²æ„å»º
- âœ… API Tokenå·²é…ç½®

### 3. éªŒè¯æœç´¢åŠŸèƒ½

æµ‹è¯•æ–°çš„æœç´¢APIï¼š

```bash
# ä½¿ç”¨curlæµ‹è¯•ï¼ˆåœ¨DSMçš„SSHä¸­ï¼‰
curl "http://localhost:8000/api/search_content/?token=43c395f68784452784585da896cb5c66&pattern=CDP&search_mode=exact&limit=1"
```

åº”è¯¥è¿”å›JSONæ ¼å¼çš„æœç´¢ç»“æœã€‚

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: å®¹å™¨å¯åŠ¨åæ— æ³•è®¿é—®ï¼Ÿ

**æ£€æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š
   ```bash
   sudo docker ps | grep mrdoc
   ```

2. æ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼š
   ```bash
   sudo docker logs mrdoc-dsm
   ```

3. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š
   ```bash
   sudo netstat -tlnp | grep 8000
   ```

### Q2: å¦‚ä½•ä¿®æ”¹ç«¯å£ï¼Ÿ

ä¿®æ”¹ `docker-compose-dsm.yml` ä¸­çš„ç«¯å£æ˜ å°„ï¼š
```yaml
ports:
  - "8080:8000"  # æ”¹ä¸º8080ç«¯å£
```

ç„¶åé‡æ–°å¯åŠ¨ï¼š
```bash
sudo docker-compose -f docker-compose-dsm.yml down
sudo docker-compose -f docker-compose-dsm.yml up -d
```

### Q3: å¦‚ä½•å¤‡ä»½æ•°æ®ï¼Ÿ

æ•°æ®éƒ½å­˜å‚¨åœ¨ `./data` ç›®å½•ä¸­ï¼š
```bash
# å¤‡ä»½æ•´ä¸ªdataç›®å½•
tar -czf mrdoc-backup-$(date +%Y%m%d).tar.gz ./data
```

### Q4: å¦‚ä½•æ›´æ–°MrDocï¼Ÿ

1. åœæ­¢å®¹å™¨ï¼š
   ```bash
   sudo docker-compose -f docker-compose-dsm.yml down
   ```

2. å¤‡ä»½æ•°æ®ï¼ˆè§Q3ï¼‰

3. æ›´æ–°ä»£ç åé‡æ–°æ„å»ºï¼š
   ```bash
   sudo docker-compose -f docker-compose-dsm.yml build
   sudo docker-compose -f docker-compose-dsm.yml up -d
   ```

### Q5: å¿˜è®°ç®¡ç†å‘˜å¯†ç æ€ä¹ˆåŠï¼Ÿ

SSHç™»å½•DSMåæ‰§è¡Œï¼š
```bash
sudo docker exec -it mrdoc-dsm python manage.py changepassword admin
```

### Q6: å¦‚ä½•æŸ¥çœ‹æ‰€æœ‰æ–‡æ¡£ï¼Ÿ

1. ç™»å½•ç³»ç»Ÿï¼ˆadmin / admin123ï¼‰
2. è®¿é—®ä¸ªäººä¸­å¿ƒ
3. ç‚¹å‡»"æˆ‘çš„æ–‡é›†"æŸ¥çœ‹æ‰€æœ‰29ä¸ªæ–‡é›†
4. æ‰€æœ‰æ–‡é›†éƒ½æ˜¯ç§å¯†çš„ï¼Œéœ€è¦ç™»å½•åæ‰èƒ½æŸ¥çœ‹

## ğŸ” APIä½¿ç”¨è¯´æ˜

### æœç´¢APIç«¯ç‚¹

```
GET/POST http://ä½ çš„DSMåœ°å€:8000/api/search_content/
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|-----|------|------|------|
| token | string | âœ“ | API Token: 43c395f68784452784585da896cb5c66 |
| pattern | string | âœ“ | æœç´¢å…³é”®è¯ |
| search_mode | string |  | æœç´¢æ¨¡å¼ï¼šexact/fuzzy/regexï¼ˆé»˜è®¤exactï¼‰|
| before_lines | int |  | å‰æ–‡ä¸Šä¸‹æ–‡è¡Œæ•°ï¼ˆé»˜è®¤0ï¼‰|
| after_lines | int |  | åæ–‡ä¸Šä¸‹æ–‡è¡Œæ•°ï¼ˆé»˜è®¤0ï¼‰|
| case_sensitive | bool |  | æ˜¯å¦åŒºåˆ†å¤§å°å†™ï¼ˆé»˜è®¤falseï¼‰|
| pid | int |  | æŒ‡å®šæ–‡é›†IDï¼ˆé»˜è®¤0ï¼Œæœç´¢æ‰€æœ‰ï¼‰|
| limit | int |  | æ¯é¡µæ–‡æ¡£æ•°ï¼ˆé»˜è®¤10ï¼‰|
| page | int |  | é¡µç ï¼ˆé»˜è®¤1ï¼‰|

### æœç´¢æ¨¡å¼è¯´æ˜

1. **exactï¼ˆç²¾ç¡®æ¨¡å¼ï¼‰**ï¼š
   - ä¿ç•™ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ç‚¹å·ï¼‰
   - ä½¿ç”¨è¯è¾¹ç•ŒåŒ¹é…
   - é€‚åˆæœç´¢ "CDP", "kt.set.contact" ç­‰

2. **fuzzyï¼ˆæ¨¡ç³Šæ¨¡å¼ï¼‰**ï¼š
   - æ ‡å‡†æ–‡æœ¬æœç´¢
   - è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
   - é€‚åˆä¸€èˆ¬æœç´¢

3. **regexï¼ˆæ­£åˆ™æ¨¡å¼ï¼‰**ï¼š
   - å®Œæ•´æ­£åˆ™è¡¨è¾¾å¼æ”¯æŒ
   - æœ€çµæ´»ä½†éœ€è¦æ­£åˆ™çŸ¥è¯†
   - é€‚åˆå¤æ‚æœç´¢

### ç¤ºä¾‹è¯·æ±‚

```bash
# ç²¾ç¡®æœç´¢
curl "http://ä½ çš„DSMåœ°å€:8000/api/search_content/?token=43c395f68784452784585da896cb5c66&pattern=CDP&search_mode=exact&before_lines=2&after_lines=2&limit=5"

# æ¨¡ç³Šæœç´¢
curl "http://ä½ çš„DSMåœ°å€:8000/api/search_content/?token=43c395f68784452784585da896cb5c66&pattern=telegram&search_mode=fuzzy"

# æ­£åˆ™æœç´¢
curl "http://ä½ çš„DSMåœ°å€:8000/api/search_content/?token=43c395f68784452784585da896cb5c66&pattern=\\bCDP\\b&search_mode=regex"
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- âœ… æœç´¢å“åº”æ—¶é—´ï¼š10-40ms
- âœ… æ–‡æ¡£æ€»æ•°ï¼š128ç¯‡
- âœ… æ–‡é›†æ€»æ•°ï¼š29ä¸ª
- âœ… æ•°æ®åº“å¤§å°ï¼šçº¦3MB
- âœ… å®¹å™¨é•œåƒå¤§å°ï¼šçº¦500MB

## ğŸ› ï¸ ç»´æŠ¤å‘½ä»¤

### æŸ¥çœ‹å®¹å™¨çŠ¶æ€
```bash
sudo docker ps -a | grep mrdoc
```

### æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
sudo docker logs -f mrdoc-dsm
```

### è¿›å…¥å®¹å™¨
```bash
sudo docker exec -it mrdoc-dsm bash
```

### é‡å¯å®¹å™¨
```bash
sudo docker restart mrdoc-dsm
```

### åœæ­¢å®¹å™¨
```bash
sudo docker stop mrdoc-dsm
```

### åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™æ•°æ®ï¼‰
```bash
sudo docker rm mrdoc-dsm
```

### é‡å»ºæœç´¢ç´¢å¼•ï¼ˆå¦‚éœ€è¦ï¼‰
```bash
sudo docker exec -it mrdoc-dsm python manage.py rebuild_index --noinput
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š`sudo docker logs mrdoc-dsm`
2. æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
3. ç¡®è®¤ç«¯å£æ²¡æœ‰è¢«å ç”¨
4. æ£€æŸ¥DSMé˜²ç«å¢™è®¾ç½®

## ğŸ‰ éƒ¨ç½²å®Œæˆ

æ­å–œï¼MrDocå·²æˆåŠŸéƒ¨ç½²åˆ°ç¾¤æ™–DSMã€‚

ç°åœ¨å¯ä»¥ï¼š
- âœ… è®¿é—® http://ä½ çš„DSMåœ°å€:8000
- âœ… ä½¿ç”¨ admin / admin123 ç™»å½•
- âœ… æŸ¥çœ‹128ç¯‡æ–‡æ¡£å’Œ29ä¸ªæ–‡é›†
- âœ… ä½¿ç”¨é«˜æ€§èƒ½æœç´¢APIï¼ˆ10-40mså“åº”ï¼‰

---

**æœ€åæ›´æ–°**: 2025-10-30
**MrDocç‰ˆæœ¬**: 0.9.6
**éƒ¨ç½²ç±»å‹**: Docker Compose on Synology DSM
