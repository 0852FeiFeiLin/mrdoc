# MrDoc Docker 部署文档

## 项目概述

本文档记录 MrDoc 项目使用 Docker Compose 的完整部署流程和配置说明。

## 技术架构

- **应用框架**: Django 4.2 + Python 3.11
- **数据库**: SQLite3
- **缓存**: Redis 7
- **Web服务器**: Nginx + Gunicorn
- **容器化**: Docker + Docker Compose

## 端口配置

| 服务 | 容器端口 | 宿主机端口 | 说明 |
|------|---------|-----------|------|
| Nginx | 80 | `${MRDOC_HTTP_PORT:-19081}` | 主入口，生产服务器固定使用 19081 避免与现有服务端口冲突 |
| Nginx HTTPS | 443 | `${MRDOC_HTTPS_PORT:-19443}` | 生产服务器固定使用 19443，若启用 HTTPS 则需开放此端口 |
| Django App | 8000 | - | 仅内网访问，通过Nginx代理 |
| Redis | 6379 | `${MRDOC_REDIS_PORT:-16380}` | Redis缓存服务，生产端口避免和已有 63xx 服务冲突 |

**访问地址**: `http://your-server-ip:${MRDOC_HTTP_PORT:-19081}`

> 生产服务器（138.128.220.113）已由自动到账系统使用 8090 端口，对外服务需避开 80/8081/8090 等既有端口，所以 MrDoc 统一绑定到 19081/19443/16380。

## 目录结构

```
${MRDOC_HOME}  # 例如 /Users/hahaha/chat--5043375108/mrdoc-dev
├── deployment/
│   ├── docker/
│   │   ├── docker-compose.yml    # Docker编排配置
│   │   ├── Dockerfile.mrdoc      # 应用镜像构建文件
│   │   └── entrypoint.sh         # 容器启动脚本
│   └── nginx/
│       ├── nginx.conf            # Nginx主配置
│       └── mrdoc.conf            # MrDoc站点配置
├── static/                       # 静态文件目录
├── media/                        # 媒体文件目录
├── config/                       # 配置文件目录
│   ├── config.ini               # 应用配置
│   └── db.sqlite3               # SQLite数据库
└── logs/                        # 日志目录
```

## 部署步骤

### 1. 前置条件

```bash
# 确保已安装 Docker 和 Docker Compose
docker --version
docker-compose --version

# 确保 Git 可用
git --version
```

### 2. 获取项目

- **本地 TAR 包**（本次交付使用）

```bash
cd /Users/hahaha/chat--5043375108
tar -xzf /Users/hahaha/Downloads/mrdoc-dev-core-20251101-053528.tar.gz
cd mrdoc-dev
```

- **Git 仓库（备选）**

```bash
git clone https://github.com/0852FeiFeiLin/mrdoc.git mrdoc-dev
cd mrdoc-dev
```

### 3. 恢复静态文件

```bash
# 静态文件可能在 Git 中被标记为删除，需要恢复
git restore static/
```

### 4. 配置目录权限

```bash
# 确保容器有权限访问挂载目录
mkdir -p log logs
chmod -R 777 config/ static/ media/ log/ logs/
```

### 5. 启动服务

```bash
cd deployment/docker
# 生产环境固定使用 19081/19443；本地调试可临时改为 18081/18443
MRDOC_HTTP_PORT=19081 MRDOC_HTTPS_PORT=19443 MRDOC_REDIS_PORT=16380 docker compose up -d --build
```

> 说明：macOS 本地因 `cordys-crm` 占用 8081/8082，示例改用 18081/18443；生产服务器固定 19081/19443，如需与其他环境统一，请同步调整 Secrets 中的端口值。

### 6. 验证部署

```bash
# 查看容器状态
docker compose ps

# 查看应用日志
docker compose logs --tail 50 mrdocs-safe-app

# 测试门户
curl -I http://localhost:${MRDOC_HTTP_PORT:-19081}

# 测试后台
curl -I http://localhost:${MRDOC_HTTP_PORT:-19081}/admin/admin_center/
```

> 若命令返回 `200 OK`（门户）与 `403 Forbidden`（后台未登录），表示路由与静态资源均正常。

## 部署验证记录（2025-11-08 本地）

- `curl -I http://localhost:18081/` 返回 `200 OK`，内容长度 34,580 字节，证明前台站点可访问。
- `curl -I http://localhost:18081/admin/admin_center/` 返回 `403 Forbidden`，符合后台未登录时的默认行为。
- `docker compose logs --tail 20 mrdocs-safe-app` 显示迁移成功、超级用户已存在、Gunicorn 4 个 worker 正常启动。
- `docker compose ps` 输出：

```
NAME                STATUS      PORTS
mrdocs-safe-app     healthy     8000/tcp
mrdocs-safe-nginx   running     0.0.0.0:18081->80/tcp, 0.0.0.0:18443->443/tcp
mrdocs-safe-redis   starting    0.0.0.0:6380->6379/tcp
```

以上记录可用于交付验证或纳入运维日志。

### 7. 访问应用

打开浏览器访问：`http://your-server-ip:${MRDOC_HTTP_PORT:-19081}`

### 8. GitHub Actions 自动部署（138.128.220.113）

GitHub 仓库已新增 `.github/workflows/deploy.yml`，在 `main` 分支推送或手动触发时，将通过 SSH 将最新代码部署到自动到账服务器。

1. **必填 Secrets**（仓库 Settings → Secrets → Actions）：
   - `DEPLOY_HOST`=`138.128.220.113`
   - `DEPLOY_PORT`=`27020`
   - `DEPLOY_USER`=`root`
   - `DEPLOY_SSH_KEY`=`<ED25519 私钥，匹配服务器 /root/.ssh/authorized_keys>`
   - `GH_DEPLOY_TOKEN`=`<GitHub Personal Access Token，需 repo 只读权限>`

2. **可选 Secrets**（用于覆盖默认运行参数）：
   - `MRDOC_HTTP_PORT`（默认 `19081`）
   - `MRDOC_HTTPS_PORT`（默认 `19443`）
   - `MRDOC_REDIS_PORT`（默认 `16380`）
   - `MRDOC_REDIS_PASSWORD`（默认 `redispassword123`）
   - `DJANGO_SECRET_KEY`、`DJANGO_SUPERUSER_*`、`DJANGO_ALLOWED_HOSTS`、`SERVER_TZ`

3. **执行流程概述**：
   - 远程目录 `/opt/mrdoc` 首次自动 `git clone`，后续 `git fetch && reset --hard origin/main`。
   - 创建持久化目录 `media/log/config` 并保留历史数据。
   - 根据 Secrets 导出部署环境变量，固定使用端口 `19081/19443/16380`。
   - 通过 `docker compose up -d --build` 更新服务，最后输出容器状态表。

4. **首次上线验证**：
   ```bash
   ssh root@138.128.220.113 -p 27020
   docker compose -f /opt/mrdoc/deployment/docker/docker-compose.yml ps
   curl -I http://138.128.220.113:19081/
   ```

5. **回滚方法**：
   - GitHub 回滚：将 `main` 回退到上一版本并重新触发 Actions。
   - 服务器回滚：进入 `/opt/mrdoc` 手动 `git checkout <tag/commit>`，再执行 `docker compose up -d --build`。

> Pipeline 默认在 3 分钟内完成构建，如遇网络抖动导致 `docker compose pull` 失败，脚本会忽略该步骤并继续使用本地缓存镜像。

默认管理员账号：
- 用户名: `admin`
- 密码: `admin123456`

## 常见问题排查

### 1. 容器不断重启

**现象**: 容器状态显示 `Restarting`

**排查步骤**:
```bash
# 查看容器日志
docker logs --tail 50 mrdocs-safe-app

# 常见原因及解决方案：
# 1. 权限问题
chmod -R 777 /root/kt/mrdocs/{config,static,media,logs}

# 2. SQLite数据库文件无法创建
# 检查 config 目录是否存在且有写权限
mkdir -p /root/kt/mrdocs/config
chmod 777 /root/kt/mrdocs/config
```

### 2. 静态文件 404

**现象**: CSS、JS、图片等资源无法加载

**解决方案**:
```bash
# 1. 恢复静态文件
cd /root/kt/mrdocs
git restore static/

# 2. 检查 Nginx 容器内挂载
docker exec mrdocs-safe-nginx ls -la /var/www/static/

# 3. 重启容器
cd deployment/docker
docker-compose restart mrdocs-safe-nginx
```

### 3. 数据库迁移失败

**现象**: 启动日志显示 `数据库迁移失败`

**解决方案**:
```bash
# 手动执行迁移
docker exec -it mrdocs-safe-app python manage.py migrate

# 如果仍失败，删除数据库重新初始化
rm /root/kt/mrdocs/config/db.sqlite3
docker-compose restart mrdocs-safe-app
```

### 4. Gunicorn 启动失败

**现象**: 日志显示 `gunicorn: not found`

**原因**: Gunicorn 安装在用户目录，不在 PATH 中

**解决方案**: 已在 `entrypoint.sh` 中使用完整路径：
```bash
/home/mrdoc/.local/bin/gunicorn
```

## 服务管理命令

### 启动服务
```bash
cd ${MRDOC_HOME}/deployment/docker
docker compose up -d
```

### 停止服务
```bash
docker compose down
```

### 重启服务
```bash
docker compose restart
```

### 查看日志
```bash
# 查看所有容器日志
docker compose logs -f

# 查看特定容器日志
docker logs -f mrdocs-safe-app
docker logs -f mrdocs-safe-nginx
docker logs -f mrdocs-safe-redis
```

### 重建容器
```bash
docker compose down
docker compose up -d --build --force-recreate
```

## 数据备份

### 1. 备份 SQLite 数据库
```bash
cp /root/kt/mrdocs/config/db.sqlite3 /backup/db.sqlite3.$(date +%Y%m%d)
```

### 2. 备份媒体文件
```bash
tar -czf /backup/media_$(date +%Y%m%d).tar.gz /root/kt/mrdocs/media/
```

### 3. 备份配置文件
```bash
tar -czf /backup/config_$(date +%Y%m%d).tar.gz /root/kt/mrdocs/config/
```

### 4. 完整备份脚本
```bash
#!/bin/bash
BACKUP_DIR="/backup/mrdocs_$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

cp /root/kt/mrdocs/config/db.sqlite3 $BACKUP_DIR/
tar -czf $BACKUP_DIR/media.tar.gz /root/kt/mrdocs/media/
tar -czf $BACKUP_DIR/config.tar.gz /root/kt/mrdocs/config/

echo "备份完成: $BACKUP_DIR"
```

## 数据恢复

### 1. 恢复数据库
```bash
# 停止应用
docker-compose stop mrdocs-safe-app

# 恢复数据库文件
cp /backup/db.sqlite3.20250930 /root/kt/mrdocs/config/db.sqlite3

# 启动应用
docker-compose start mrdocs-safe-app
```

### 2. 恢复媒体文件
```bash
tar -xzf /backup/media_20250930.tar.gz -C /root/kt/mrdocs/
```

## 配置说明

### 环境变量 (docker-compose.yml)

```yaml
environment:
  - DB_ENGINE=${MRDOC_DB_ENGINE:-sqlite}                  # 数据库引擎
  - DB_NAME=${MRDOC_DB_PATH:-/app/config/db.sqlite3}      # 数据库文件路径
  - REDIS_HOST=${MRDOC_REDIS_HOST:-mrdocs-safe-redis}     # Redis主机
  - REDIS_PORT=${MRDOC_REDIS_PORT:-6379}                  # Redis端口（容器内）
  - REDIS_PASSWORD=${MRDOC_REDIS_PASSWORD:-redispassword123}  # Redis密码
  - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-***}           # Django密钥
  - DJANGO_DEBUG=${DJANGO_DEBUG:-False}                   # 调试模式
  - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-*}       # 允许的主机
  - DJANGO_SUPERUSER_USERNAME=${DJANGO_SUPERUSER_USERNAME:-admin}
  - DJANGO_SUPERUSER_EMAIL=${DJANGO_SUPERUSER_EMAIL:-admin@example.com}
  - DJANGO_SUPERUSER_PASSWORD=${DJANGO_SUPERUSER_PASSWORD:-admin123456}
  - REDIS_DB=${MRDOC_REDIS_DB:-4}                         # Redis DB编号
  - TZ=${TZ:-Asia/Shanghai}                               # 时区

ports:
  - "${MRDOC_HTTP_PORT:-8081}:80"
  - "${MRDOC_HTTPS_PORT:-8443}:443"
  - "${MRDOC_REDIS_PORT:-6380}:6379"
```

### Nginx 配置要点

**位置**: `deployment/nginx/nginx.conf`

- Upstream 后端地址: `mrdocs-safe-app:8000`
- Worker 进程: `auto`
- Worker 连接数: `1024`

**位置**: `deployment/nginx/mrdoc.conf`

- 静态文件路径: `/var/www/static/`
- 媒体文件路径: `/var/www/media/`
- 客户端上传限制: `100M`
- 静态文件缓存: `30天`
- 媒体文件缓存: `7天`

## 性能优化建议

### 1. Gunicorn Workers
```bash
# 当前配置: 4 workers
# 推荐公式: (2 × CPU核心数) + 1
# 修改位置: deployment/docker/entrypoint.sh
```

### 2. Redis 内存限制
```yaml
# 在 docker-compose.yml 中添加
command: redis-server --requirepass redispassword123 --maxmemory 256mb --maxmemory-policy allkeys-lru
```

### 3. Nginx 缓存
```nginx
# 在 nginx.conf 中启用缓存
proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=cache:10m inactive=60m;
```

## 安全建议

### 1. 修改默认密码
```bash
# 登录后立即修改管理员密码
# 同时修改 docker-compose.yml 中的密码
```

### 2. 修改 Redis 密码
```yaml
# 在 docker-compose.yml 中修改
- REDIS_PASSWORD=your-strong-password
command: redis-server --requirepass your-strong-password
```

### 3. 修改 Django SECRET_KEY
```yaml
# 生成新的 SECRET_KEY
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"

# 在 docker-compose.yml 中替换
- DJANGO_SECRET_KEY=your-generated-secret-key
```

### 4. 配置 HTTPS (可选)
```bash
# 准备 SSL 证书
mkdir -p deployment/nginx/ssl
cp your-cert.pem deployment/nginx/ssl/
cp your-key.pem deployment/nginx/ssl/

# 在 mrdoc.conf 中启用 HTTPS 配置段
```

## 监控和日志

### 应用日志位置
```bash
# 容器内日志
docker exec mrdocs-safe-app ls /app/logs/

# Nginx 日志
docker logs mrdocs-safe-nginx

# Gunicorn 日志（输出到 stdout）
docker logs mrdocs-safe-app
```

### 健康检查
```bash
# 应用健康检查
curl http://localhost:8081/

# Redis 健康检查
docker exec mrdocs-safe-redis redis-cli -a redispassword123 ping
```

## 更新部署

### 1. 拉取最新代码
```bash
cd /root/kt/mrdocs
git pull origin master
```

### 2. 恢复静态文件（如需要）
```bash
git restore static/
```

### 3. 重建并重启容器
```bash
cd deployment/docker
docker-compose down
docker-compose up -d --build
```

### 4. 执行数据库迁移（如有新迁移）
```bash
docker exec mrdocs-safe-app python manage.py migrate
```

## 故障恢复流程

### 完全重新部署
```bash
# 1. 备份数据
cp /root/kt/mrdocs/config/db.sqlite3 /backup/
tar -czf /backup/media.tar.gz /root/kt/mrdocs/media/

# 2. 停止并删除所有容器
cd /root/kt/mrdocs/deployment/docker
docker-compose down -v

# 3. 恢复静态文件
cd /root/kt/mrdocs
git restore static/

# 4. 设置权限
chmod -R 777 config/ static/ media/ logs/

# 5. 重新部署
cd deployment/docker
docker-compose up -d --build

# 6. 恢复数据
cp /backup/db.sqlite3 /root/kt/mrdocs/config/
```

## 技术支持

- **项目地址**: https://github.com/0852FeiFeiLin/mrdoc
- **官方文档**: 见项目 README.md
- **问题反馈**: GitHub Issues

## 部署清单

部署完成后，请确认以下项目：

- [ ] 所有容器状态为 `Up` 和 `healthy`
- [ ] 可以访问 `http://server-ip:8081`
- [ ] 静态文件（CSS/JS/图片）加载正常
- [ ] 可以使用管理员账号登录
- [ ] 已修改默认密码
- [ ] 已配置数据备份计划
- [ ] 日志输出正常

---

**部署日期**: 2025-09-30
**部署人员**: Arise
**部署状态**: ✅ 验收通过
