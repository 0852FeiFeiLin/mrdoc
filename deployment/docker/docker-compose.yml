services:
  # MrDoc 主应用
  mrdocs-dev-app:
    build:
      context: ../..
      dockerfile: deployment/docker/Dockerfile.mrdoc
    container_name: mrdocs-dev-app
    restart: unless-stopped
    volumes:
      - ../../media:/app/media
      - ../../log:/app/log
      - ../../static:/app/static
      - ../../config:/app/config
    environment:
      - DB_ENGINE=${MRDOC_DB_ENGINE:-sqlite}
      - DB_NAME=${MRDOC_DB_PATH:-/app/config/db.sqlite3}
      - REDIS_HOST=${MRDOC_REDIS_HOST:-mrdocs-dev-redis}
      - REDIS_PORT=${MRDOC_REDIS_PORT:-6379}
      - REDIS_PASSWORD=${MRDOC_REDIS_PASSWORD:-redispassword123}
      - DJANGO_SETTINGS_MODULE=MrDoc.settings
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-django_safe_secret_6WZlZsnpSV78ie9OZDmXPFodGnGWc2FNjJBuOIQqhPc}
      - DJANGO_DEBUG=${DJANGO_DEBUG:-False}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-*}
      - DJANGO_SUPERUSER_USERNAME=${DJANGO_SUPERUSER_USERNAME:-admin}
      - DJANGO_SUPERUSER_EMAIL=${DJANGO_SUPERUSER_EMAIL:-admin@example.com}
      - DJANGO_SUPERUSER_PASSWORD=${DJANGO_SUPERUSER_PASSWORD:-admin123456}
      - REDIS_DB=${MRDOC_REDIS_DB:-4}
      - TZ=${TZ:-Asia/Shanghai}
    networks:
      - mrdocs-dev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    depends_on:
      - mrdocs-dev-redis

  # Redis 缓存
  mrdocs-dev-redis:
    image: redis:7-alpine
    container_name: mrdocs-dev-redis
    restart: unless-stopped
    volumes:
      - mrdocs-dev_redis_data:/data
    ports:
      - "${MRDOC_REDIS_PORT:-16380}:6379"
    networks:
      - mrdocs-dev-network
    command: redis-server --requirepass ${MRDOC_REDIS_PASSWORD:-redispassword123} --databases 16
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${MRDOC_REDIS_PASSWORD:-redispassword123}", "ping"]
      interval: 30s
      timeout: 3s
      retries: 5

  # Nginx 反向代理
  mrdocs-dev-nginx:
    image: nginx:alpine
    container_name: mrdocs-dev-nginx
    restart: unless-stopped
    ports:
      - "8088:80"
      - "${MRDOC_HTTPS_PORT:-19443}:443"
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf
      - ../nginx/mrdoc.conf:/etc/nginx/conf.d/default.conf
      - ../../static:/var/www/static
      - ../../media:/var/www/media
    networks:
      - mrdocs-dev-network
    depends_on:
      - mrdocs-dev-app

# 数据卷定义
volumes:
  mrdocs-dev_redis_data:

# 网络定义
networks:
  mrdocs-dev-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.32.0.0/16
          gateway: 172.32.0.1
